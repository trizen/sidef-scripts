#!/usr/bin/ruby

# Author: Daniel "Trizen" È˜uteu
# Date: 31 March 2019
# https://github.com/trizen

# A new algorithm for generating Fermat pseudoprimes to base 2.

# See also:
#   https://oeis.org/A050217 -- Super-Poulet numbers: Poulet numbers whose divisors d all satisfy d|2^d-2.
#   https://oeis.org/A214305 -- Fermat pseudoprimes to base 2 with two prime factors.

# See also:
#   https://en.wikipedia.org/wiki/Fermat_pseudoprime
#   https://trizenx.blogspot.com/2018/08/investigating-fibonacci-numbers-modulo-m.html

func fermat_pseudoprimess(limit) {

    var table = Hash()

    for p in (limit.primes) {
        for d in (divisors(p - 1)) {
            if (powmod(2, d, p) == 1) {
                table{d} := [] << p
            }
        }
    }

    gather {
        table.each_v { |a|

            var L = a.len
            L > 1 || next

            for k in (2..L) {
                a.combinations(k, {|*t|
                    take(t.prod)
                })
            }
        }
    }.uniq
}

func is_fermat_pseudoprime(n) {
    powmod(2, n-1, n)
}

var pseudoprimes = fermat_pseudoprimess(10000)

pseudoprimes.each {|n|

    assert(is_fermat_pseudoprime(n))

    if (n.legendre(5) == -1) {
        if (fibmod(n - n.legendre(5), n) == 0) {
            die "Found a special pseudoprime: #{n}"
        }
    }
}

say pseudoprimes.sort

__END__
[341, 1387, 2047, 2701, 3277, 4033, 4369, 4681, 5461, 7957, 8321, 10261, 13747, 14491, 15709, 18721, 19951, 23377, 31417, 31609, 31621, 35333, 42799, 49141, 49981, 60701, 60787, 65077, 65281, 80581, 83333, 85489, 88357, 90751, 104653, 123251, 129889, 130561, 150851, 162193, 164737, 181901, 188057, 194221, 196093, 215749, 219781, 220729, 226801, 233017, 241001, 249841, 253241, 256999, 264773, 271951, 275887, 280601, 282133, 294271, 294409, 318361, 357761, 390937, 396271, 422659, 435671, 443719, 452051, 458989, 481573, 486737, 489997, 513629, 514447, 556169, 580337, 582289, 587861, 604117, 611701, 642001, 647089, 653333, 657901, 665281, 665333, 672487, 679729, 680627, 688213, 710533, 721801, 722201, 722261, 729061, 741751, 742813, 745889, 769567, 769757, 818201, 838861, 873181, 877099, 916327, 976873, 983401, 1016801, 1053761, 1064053, 1073021, 1082401, 1092547, 1132657, 1168513, 1207361, 1251949, 1252697, 1277179, 1293337, 1302451, 1325843, 1357441, 1373653, 1398101, 1433407, 1441091, 1457773, 1493857, 1507963, 1509709, 1530787, 1537381, 1549411, 1584133, 1678541, 1690501, 1730977, 1735841, 1755001, 1809697, 1811573, 1826203, 1840357, 1876393, 1969417, 1987021, 1994689, 2004403, 2008597, 2035153, 2081713, 2134277, 2163001, 2181961, 2184571, 2205967, 2261953, 2264369, 2269093, 2284453, 2304167, 2313697, 2387797, 2434651, 2487941, 2491637, 2510569, 2617451, 2649029, 2670361, 2746477, 2746589, 2748023, 2757241, 2811271, 2909197, 2944261, 2976487, 2977217, 3059101, 3090091, 3116107, 3125281, 3235699, 3337849, 3345773, 3363121, 3375041, 3375487, 3400013, 3539101, 3542533, 3568661, 3656449, 3898129, 3985921, 4082653, 4101637, 4151869, 4181921, 4188889, 4314967, 4360621, 4361389, 4415251, 4469471, 4480477, 4513841, 4567837, 4863127, 4868701, 4922413, 5016191, 5044033, 5095177, 5131589, 5173169, 5173601, 5176153, 5256091, 5351537, 5423713, 5489641, 5524693, 5575501, 5672041, 5766001, 5919187, 6027193, 6122551, 6140161, 6226193, 6233977, 6236257, 6278533, 6334351, 6368689, 6386993, 6539527, 6658669, 6749021, 6779137, 6787327, 6912079, 6952037, 6955541, 6973063, 7017193, 7232321, 7295851, 7306261, 7306561, 7462001, 7674967, 7725901, 7759937, 7820201, 7883731, 8036033, 8095447, 8231653, 8650951, 8725753, 8745277, 8902741, 9006401, 9037729, 9040013, 9056501, 9073513, 9131401, 9273547, 9371251, 9480461, 9533701, 9591661, 9729301, 9863461, 10031653, 10084177, 10386241, 10402237, 10403641, 10425511, 10505701, 10610063, 10712857, 10974881, 11335501, 11367137, 11541307, 11585293, 12032021, 12273769, 12322133, 12599233, 12659989, 12711007, 13073941, 13295281, 13338371, 13421773, 13694761, 13747361, 13773061, 13856417, 13991647, 13996951, 14026897, 14179537, 14282143, 14324473, 14589901, 14794081, 14899751, 15139199, 15162941, 15188557, 15268501, 15525241, 15583153, 15621409, 15732721, 15757741, 15976747, 15978007, 16070429, 16324001, 16349477, 16717061, 16853077, 16973393, 17116837, 17327773, 17375249, 17405537, 17870561, 18073817, 18443701, 18535177, 18653353, 18736381, 18985627, 19020191, 19328653, 19404139, 19985269, 20081953, 20117467, 20234341, 20261251, 21306157, 21355951, 21397381, 21654533, 21907009, 22137809, 22369621, 22591301, 22669501, 23247901, 23261713, 23315977, 23464033, 23963869, 24904153, 25276421, 25457833, 25696133, 25909453, 26470501, 26977001, 27108397, 27331921, 27409541, 27509653, 27664033, 27798461, 27808463, 28011001, 28325881, 28406953, 28717483, 29581501, 29593159, 30058381, 30529693, 30881551, 31040833, 32091781, 32701297, 34890481, 35851037, 36307981, 37962541, 38118763, 38439523, 40361197, 42485119, 42702661, 43363601, 45219329, 46094401, 46325029, 46517857, 47253781, 47918581, 48191653, 48448661, 49075417, 52181407, 53154337, 53283169, 53675623, 55318957, 55610837, 61377109, 63001801, 63781901, 64605041, 66384121, 67763803, 74658629, 78526729, 90341197, 96916279, 109322501, 135945853, 153369061, 157010389, 163442551, 206453509, 221415781, 231927781, 271682651, 367632301, 434042801, 457457617, 464955857, 491738801, 516045197, 536870911, 604611019, 611097401, 612006253, 630622753, 762278161, 1101673501, 1220114377, 1299963601, 1319978701, 1441139641, 1473580001, 1541955409, 1767200059, 1831258601, 1879623157, 1921295359, 2284569169, 2299876417, 2344578077, 2813372869, 2882370481, 2930420351, 3002647829, 3034402681, 3045287797, 3516565057, 3576818293, 3650158849, 4215885697, 4295435629, 4384806451, 4550912389, 4562359201, 4563568819, 5099822341, 5256967999, 5726579371, 5847309901, 6082391617, 6221531233, 7030714813, 7112441977, 7492766161, 7629221377, 8025562777, 8173975021, 8352286141, 8768530501, 8788016089, 9536234593, 9761467669, 9972894583, 10545166433, 11500521553, 11847382193, 12236182687, 12640344193, 13079177569, 13143202489, 13802550829, 17522471101, 18229099393, 18723407341, 19089110641, 19463358097, 19742849041, 20378724731, 21468635801, 21604034453, 21792816121, 25258781377, 28068637801, 28741893457, 30606632449, 31221259651, 31675383749, 32456510101, 35084290453, 37408911097, 37418488801, 39974135479, 42099340541, 42352289149, 43215089153, 45983665729, 49944700297, 50294058751, 51094460611, 57097913533, 59850086533, 63776528677, 65700513721, 67965754429, 78889735961, 91918256041, 99737787437, 102125919421, 105207688757, 125402926477, 149583518641, 152230013833, 168003672409, 191557957189, 193601185171, 194305088689, 256737574117, 257506553303, 442429869787, 589837675213, 662105774101, 885621580601, 1100586419201, 1537515050737, 4117335954337, 10531005131701, 10918700104589, 12268183891489, 12272059592053, 13647788986217, 14574316854529, 16376643470449, 23353046634997, 24733621097461, 40925790926473, 62262075657697, 86127405910417, 163387540639621, 322053315634073, 1264022137981459, 63557753308812569]
