#!/usr/bin/ruby

# Author: Daniel "Trizen" È˜uteu
# Date: 23 February 2018
# https://github.com/trizen

# A new recurrence for computing the number of 3Xn arrays with rows being
# permutations of 0..n-1 and no column j greater than column j-1 in all rows.

# Formula:
#  a(0) = 1
#  a(n) = Sum_{k=0..n-1} (-1)^(n-k+1) * a(k) * binomial(n, k)^2 / (n-k)!

# Alternative formula:
#  a(0) = 1
#  a(n) = Sum_{k=0..n-1} (-1)^(n-k+1) * a(k) * (n!)^2 / ((k!)^2 * ((n - k)!)^3)

# Which gives us the n-th term as:
#   A212856(n) = a(n) * n!

# See also:
#    https://oeis.org/A212856

func a((0)) { 1 }

func a(n) is cached {
    sum(^n, {|k| (-1)**(n+k+1) * a(k) * binomial(n, k)**2 / (n-k)! })
}

for n in (0..30) {
    printf("P(%2d) = %s\n", n, a(n) * n!)
}

__END__
P( 0) = 1
P( 1) = 1
P( 2) = 7
P( 3) = 163
P( 4) = 8983
P( 5) = 966751
P( 6) = 179781181
P( 7) = 53090086057
P( 8) = 23402291822743
P( 9) = 14687940716402023
P(10) = 12645496977257273257
P(11) = 14490686095184389113277
P(12) = 21557960797148733086439949
P(13) = 40776761007750226749220637461
P(14) = 96332276574683758035941025907591
P(15) = 279911403663149794444537429063419163
P(16) = 987087224677929323204610747907554143383
P(17) = 4175200023526525235082867416910949811463991
P(18) = 20963789616062335572945141051729989862027992689
P(19) = 123795707604639746379553815402432820989849694941589
P(20) = 852649544916071980754508856836632602848392821147046233
P(21) = 6798348750946735705833246605965095568221871107967451146993
P(22) = 62322730622833832244828757235364001944361358025995875408534531
P(23) = 652837318789117616871794273243676244141504327723564066724034326839
P(24) = 7769868856665527040988890432913538135563561617420047195518986572278669
P(25) = 104522239339697295339875462298642689520404114303354147018426265879719185501
P(26) = 1581625799825110357848651973800486336674395833236317507580842775562567786895651
P(27) = 26802174116359456674111359979921325754717029525182389163450904626497275023759711007
P(28) = 506546255459410954319120246294200876999672622651012137000998564817025188034154939307063
P(29) = 10636239159092395862362997679399943783962194298860051673897748430045770585777189491688675183
P(30) = 247244619442610967789792576575870733281958204783170178841903321545323262644935576722296862804181
